#!/bin/bash

EZTSM_USER="eztsm"
export RAILS_ENV="production"
export SECRET_KEY_BASE="$(su - $EZTSM_USER -c 'bundle exec rake secret')"
EZTSM_BASEDIR="/opt/eztsm"
LOGFILE="$EZTSM_BASEDIR/log/eztsm.log"

start() {
  RETVAL=0
  echo -n "Starting ezTSM......."
  su - $EZTSM_USER -c "cd $EZTSM_BASEDIR && bin/rails s -b 0.0.0.0" > $LOGFILE 2>&1
  RETVAL=$?

  if [ $RETVAL -eq 0 ]
    then echo "OK"
  else
    echo "FAILED. Err code: $RETVAL"
    echo "Check $LOGFILE for more informations."
  fi

  return $RETVAL
}

stop() {
  RETVAL=0
  echo -n "Stopping ezTSM:"
  killall rails > /dev/null
  RETVAL=$?
  sleep 1
  LEFT=$(ps -ef | pgrep rails | wc -l)
  if [ $LEFT -eq 0 ] && [ $RETVAL -eq 0 ]
  then
    echo " OK "
  else
    echo "FAIL"
    [ $RETVAL -eq 0 ] && RETVAL=1
  fi
  return $RETVAL
}

#--------MAIN--------------------------
# See how we were called.
case "$1" in
  start)
        start
        ;;
  stop)
        stop
        ;;
  restart)
        stop
        [ $1 -ne 0 ] && exit $RETVAL
        echo "Stopped ezTSM. Now starting"
        sleep 1
        start
        ;;
  *)
        echo $"Usage: eztsm {start|stop|restart}"
        exit 1
esac

exit $RETVAL

